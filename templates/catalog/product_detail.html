{% extends "base.html" %}
{% block title %}Ofertum · Detalle producto{% endblock %}

{% block content %}
{% if error %}
  <div class="alert alert-warning">{{ error }}</div>
{% else %}
  <div class="row">
    <div class="col-md-8">
      <h2>{{ producto.nombre }}</h2>
      <p class="text-muted">Categoría: {{ producto.categoria }} · Tienda: {{ producto.tienda }}</p>
      <p class="text-muted">Fecha de creación: {{ producto.creado }}</p>

      {% if producto.imagen %}
        <div class="mb-3">
          <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="img-fluid rounded-3">
        </div>
      {% endif %}

      <div class="mb-3">
        <strong>Precio base:</strong> ${{ producto.precio }}
      </div>

      <div class="mb-3">
        <strong>Precio con descuento:</strong> ${{ producto.obtener_precio_actual }}
      </div>

      <div class="mb-3">
        <strong>Descuento (%):</strong> {{ oferta.descuento_porcentaje }}
      </div>

      <h4 class="mt-4">Detalles del producto</h4>
      <ul>
        <li><strong>Nombre:</strong> {{ producto.nombre }}</li>
        <li><strong>Descripción:</strong> {{ producto.descripcion }}</li>
        <li><strong>Categoría:</strong> {{ producto.categoria }}</li>
        <li><strong>Tienda:</strong> {{ producto.tienda }}</li>
      </ul>
      <hr>
      <h4>Valoraciones</h4>
      <p>
        {% if producto.avg_rating %}
          <strong>Puntuación media:</strong> {{ producto.avg_rating|floatformat:1 }} / 5
          · <strong>Reseñas:</strong> {{ producto.rating_count }}
        {% else %}
          No hay valoraciones todavía.
        {% endif %}
      </p>

      <h5>Comentarios</h5>
      {% if producto.reviews.exists %}
        <ul class="list-unstyled">
          {% for r in producto.reviews.all %}
            <li class="border p-2 mb-2">
              <strong>{{ r.usuario.username }}</strong> · {{ r.rating }} ⭐
              <div class="small text-muted">{{ r.creado }}</div>
              <p>{{ r.comentario }}</p>
              {% if request.user.is_authenticated and request.user == r.usuario %}
                <a href="{% url 'catalog:add_or_edit_review' producto.pk %}" class="btn btn-sm btn-outline-secondary">Editar</a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">No hay comentarios todavía.</p>
      {% endif %}

      {% if request.user.is_authenticated %}
        <a href="{% url 'catalog:add_or_edit_review' producto.pk %}" class="btn btn-primary">Añadir / Editar mi reseña</a>
      {% else %}
        <p><a href="/admin/login/?next={{ request.path }}">Inicia sesión</a> para valorar y comentar.</p>
      {% endif %}

    </div>
    <div class="col-md-4">
      <div class="p-3 bg-white rounded-4 shadow-sm text-center">
        <div class="h3 mb-0">Comprar</div>
        <a class="btn btn-primary" href="{{ producto.link }}">Ir a oferta</a>
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}
